<h1 class="h2 mb-4">Quản lý Khóa học</h1>

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-book-half me-2"></i>Danh sách tất cả khóa học</span>
        {{!-- BẮT ĐẦU THÊM FILTER --}}
        <div class="d-flex align-items-center">
            
            <label for="categoryFilter" class="form-label mb-0 me-2 small fw-bold">Lĩnh vực:</label>
            <select class="form-select form-select-sm me-3 w-auto" id="categoryFilter" onchange="filterCourses()">
                <option value="">Tất cả</option>
                {{#each this.allCategories}}
                    {{!-- So sánh ID là số (dùng parseInt) --}}
                    <option value="{{this.id}}" {{#if (eq (parseInt this.id) (parseInt ../currentCategory))}}selected{{/if}}>
                        {{this.category_name}}
                    </option>
                {{/each}}
            </select>

            <label for="instructorFilter" class="form-label mb-0 me-2 small fw-bold">Giảng viên:</label>
            <select class="form-select form-select-sm w-auto" id="instructorFilter" onchange="filterCourses()">
                <option value="">Tất cả</option>
                {{#each this.allInstructors}}
                    {{!-- So sánh ID là số (dùng parseInt) --}}
                    <option value="{{this.instructor_id}}" {{#if (eq (parseInt this.instructor_id) (parseInt ../currentInstructor))}}selected{{/if}}>
                        {{this.name}}
                    </option>
                {{/each}}
            </select>
        </div>
        {{!-- KẾT THÚC THÊM FILTER --}}
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Tên khóa học</th>
                        <th scope="col">Giảng viên</th>
                        <th scope="col">Danh mục</th>
                        <th scope="col">Giá</th>
                        <th scope="col">Trạng thái</th>
                        <th scope="col">Trạng thái Khóa</th> 
                        <th scope="col" class="text-end">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each this.courses}}
                    <tr>
                        <th scope="row">{{this.id}}</th>
                        <td>{{this.title}}</td>
                        <td>{{this.lecturer_name}}</td>
                        <td>{{this.category_name}}</td>
                        <td>{{format_currency this.price}}</td>
                        <td>
                            {{#if this.is_complete}}
                                <span class="badge bg-success">Hoàn thành</span>
                            {{else}}
                                <span class="badge bg-warning text-dark">Chưa hoàn thành</span>
                            {{/if}}
                        </td>
                        {{!-- CỘT TRẠNG THÁI KHÓA --}}
                        <td>
                            {{#if (eq this.is_active false)}}
                                <span class="badge bg-danger">Đã khóa</span>
                            {{else}}
                                <span class="badge bg-success">Hoạt động</span>
                            {{/if}}
                        </td>
                        {{!-- CỘT HÀNH ĐỘNG --}}
                        <td class="text-end">
                            {{!-- BẮT ĐẦU NÚT KHÓA/MỞ KHÓA --}}
                            <form action="/admin/courses/toggle-lock" method="POST" class="d-inline"
                                onsubmit="return confirm('Bạn có chắc chắn muốn {{#if (eq this.is_active false)}}MỞ KHÓA{{else}}KHÓA{{/if}} khóa học {{this.title}}?');">
                                <input type="hidden" name="id" value="{{this.id}}">
                                <input type="hidden" name="currentStatus" value="{{this.is_active}}">
                                <button type="submit" class="btn btn-sm {{#if (eq this.is_active false)}}btn-outline-success{{else}}btn-outline-warning{{/if}} me-2">
                                    {{#if (eq this.is_active false)}}
                                        <i class="bi bi-unlock-fill"></i> Mở khóa
                                    {{else}}
                                        <i class="bi bi-lock-fill"></i> Khóa
                                    {{/if}}
                                </button>
                            </form>
                            {{!-- KẾT THÚC NÚT KHÓA/MỞ KHÓA --}}

                            <form action="/admin/courses/delete" method="POST" style="display: inline-block;"
                                onsubmit="return confirm('Bạn có chắc chắn muốn gỡ bỏ khóa học này? Mọi dữ liệu liên quan (bài giảng, feedback,...) cũng sẽ bị xóa vĩnh viễn.');">
                                <input type="hidden" name="id" value="{{this.id}}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash-fill"></i> Gỡ bỏ
                                </button>
                            </form>
                        </td>
                    </tr>
                    {{else}}
                    <tr>
                        <td colspan="8" class="text-center">Chưa có khóa học nào.</td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
</div>

{{#section 'js'}}
<script>
    function filterCourses() {
        const categoryId = document.getElementById('categoryFilter').value;
        const instructorId = document.getElementById('instructorFilter').value;
        const url = new URL(window.location.href);

        // Xử lý filter Category
        if (categoryId === '' || categoryId === 'all') {
            url.searchParams.delete('category');
        } else {
            url.searchParams.set('category', categoryId);
        }

        // Xử lý filter Instructor
        if (instructorId === '' || instructorId === 'all') {
            url.searchParams.delete('instructor');
        } else {
            url.searchParams.set('instructor', instructorId);
        }
        
        // Chuyển hướng
        window.location.href = url.toString();
    }
</script>
{{/section}}