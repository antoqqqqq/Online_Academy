<link rel="stylesheet" href="/css/profile.css">
<div class="container">
    <div class="header">
        <a href="/" class="back-home">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Trang chủ
        </a>
        <h1>Cài đặt tài khoản</h1>
        <p>Cập nhật thông tin cá nhân của bạn</p>
    </div>

    <!-- Form 1: Thông tin cơ bản -->
    <div class="form-section">
        <div class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Thông tin cơ bản
        </div>

        <form id="profileForm" >
            <div class="form-group">
                <label for="fullName">Họ và tên</label>
                <input type="text" id="fullName" placeholder="Họ và tên" value="{{user.name}}" name="name" required>
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="example@email.com" value="{{user.email}}" name="email"
                    required>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                <button type="button" class="btn btn-secondary" onclick="resetProfileForm()">↺ Đặt lại</button>
            </div>

            <div id="alertBoxProfile" class="alert"></div>
        </form>
    </div>


    <!-- Form 2: Thay đổi mật khẩu -->
    <div class="form-section">
        <div class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Thay đổi mật khẩu
        </div>

        <form id="passwordForm" >
            <div class="form-group">
                <label for="currentPassword">Mật khẩu hiện tại *</label>
                <div class="password-group">
                    <input type="password" id="currentPassword" name="currentPassword"
                        placeholder="Nhập mật khẩu hiện tại" required>

                </div>
            </div>

            <div class="form-group">
                <label for="newPassword">Mật khẩu mới *</label>
                <div class="password-group">
                    <input type="password" id="newPassword" name="newPassword" placeholder="Nhập mật khẩu mới" required>

                </div>
                <div class="password-requirements">
                    Mật khẩu phải có ít nhất 6 kí tự
                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Xác nhận mật khẩu mới *</label>
                <div class="password-group">
                    <input type="password" id="confirmPassword" name="confirmPassword"
                        placeholder="Nhập lại mật khẩu mới" required>

                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Đổi mật khẩu</button>
                <button type="button" class="btn btn-secondary" onclick="resetPasswordForm()">↺ Đặt lại</button>
            </div>

            <div id="alertBoxPassword" class="alert"></div>
        </form>
    </div>
    {{#if err_message}}
    <div class="alert alert-danger mb-3" role="alert">
        {{err_message}}
    </div>
    {{/if}}
</div>
{{#section 'js'}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.getElementById('profileForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const fullName = document.getElementById('fullName').value;
        const email = document.getElementById('email').value;
        if (!fullName || !email) {
            Swal.fire({
                title: 'Error!',
                text: 'Vui lòng điền đầy đủ thông tin.',
                icon: 'error',
                confirmButtonText: 'Cool'
            });
            return;
        }
        if (email.length === 0) {
            // alert('Username is required.');
            Swal.fire({
                title: 'Error!',
                text: 'email is required.',
                icon: 'error',
                confirmButtonText: 'Cool'
            })
            return;
        } else if (!/^[\w.-]+@[a-zA-Z\d.-]+\.[a-zA-Z]{2,}$/.test(email)) {
            Swal.fire({
                title: 'Error!',
                text: 'Please enter a valid email address.',
                icon: 'error',
                confirmButtonText: 'Cool'
            })
            return;
        }
        try {
            const response = await fetch('/account/profile/changeprofile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: fullName,
                    email: email
                })
            });
            const result = await response.json();
            if (result.success) {
                Swal.fire({
                    title: 'Success!',
                    text: result.err_message,
                    icon: 'success',
                    confirmButtonText: 'Cool'
                })
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: result.err_message,
                    icon: 'error',
                    confirmButtonText: 'Cool'
                })
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error!',
                text: 'An error occurred while updating profile.',
                icon: 'error',
                confirmButtonText: 'Cool'
            }).then(() => {
                // Optionally, you can reload the page or update the UI
                location.reload();
            });
        }

    });
    document.getElementById('passwordForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword.length < 6) {
            Swal.fire({
                title: 'Error!',
                text: 'Mật khẩu phải có ít nhất 6 kí tự.',
                icon: 'error',
                confirmButtonText: 'Cool'
            });
            return;
        }

        if (newPassword !== confirmPassword) {
            Swal.fire({
                title: 'Error!',
                text: 'Mật khẩu mới và xác nhận mật khẩu không khớp.',
                icon: 'error',
                confirmButtonText: 'Cool'
            });
            return;
        }
        try {
            const response = await fetch('/account/profile/changepassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    currentPassword: currentPassword,
                    newPassword: newPassword
                })
            });
            const result = await response.json();
            if (result.success) {
                Swal.fire({
                    title: 'Success!',
                    text: result.err_message,
                    icon: 'success',
                    confirmButtonText: 'Cool'
                }).then(() => {
                    // Clear form fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                });
                resetPasswordForm();
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: result.err_message,
                    icon: 'error',
                    confirmButtonText: 'Cool'
                }).then(() => {
                    // Clear form fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error!',
                text: 'An error occurred while changing password.',
                icon: 'error',
                confirmButtonText: 'Cool'
            }).then(() => {
                // Clear form fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            });
        }
    });
</script>
{{/section}}