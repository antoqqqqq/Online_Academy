<div class="container-fluid py-2">
    {{!-- Header với gradient --}}
    <div class="row mb-3">
        <div class="col-12">
            <div class="lecture-header text-center py-3 px-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
                <h4 class="mb-1 fw-bold">
                    <i class="bi bi-play-circle-fill me-2"></i>
                    {{course.title}}
                </h4>
                <small class="opacity-75">{{course.instructor_name}}</small>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar với danh sách bài giảng -->
        <div class="col-lg-3 col-md-4">
            <div class="card lecture-sidebar shadow-sm">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-list-ul me-2"></i> Nội dung khóa học
                    </h6>
                </div>
                <div class="card-body p-0">
                    {{!-- Progress Section --}}
                    <div class="course-progress mb-3 p-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted fw-bold">Tiến độ</small>
                            <span class="badge bg-success">{{courseProgress.progressPercentage}}%</span>
                        </div>
                        <div class="progress mb-2" style="height: 8px; border-radius: 10px;">
                            <div class="progress-bar" 
                                 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: {{courseProgress.progressPercentage}}%"></div>
                        </div>
                        <small class="text-muted d-block text-center">
                            {{courseProgress.completedLectures}}/{{courseProgress.totalLectures}} chương
                        </small>
                    </div>
                    
                    <div class="lecture-list" style="max-height: 600px; overflow-y: auto;">
                        {{#each allLectures}}
                        <div class="lecture-item {{#if (eq this.id ../lecture.id)}}active{{/if}}">
                            <a href="/courses/{{../course.course_id}}/lecture/{{this.id}}" 
                               class="d-flex align-items-center p-3 text-decoration-none {{#if (eq this.id ../lecture.id)}}bg-gradient text-white shadow-sm{{else}}text-dark hover-lecture{{/if}}"
                               style="{{#if (eq this.id ../lecture.id)}}background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;{{else}}transition: all 0.3s;{{/if}}">
                                <div class="lecture-icon me-3">
                                    {{#if (eq this.id ../lecture.id)}}
                                        <i class="bi bi-play-circle-fill text-white fs-5"></i>
                                    {{else}}
                                        <i class="bi bi-play-circle text-muted fs-5"></i>
                                    {{/if}}
                                </div>
                                <div class="lecture-content flex-grow-1">
                                    <h6 class="mb-1 fw-bold {{#if (eq this.id ../lecture.id)}}text-white{{else}}text-dark{{/if}}" style="font-size: 0.9rem;">
                                        {{this.lecture_title}}
                                    </h6>
                                    <small class="{{#if (eq this.id ../lecture.id)}}text-white-50{{else}}text-muted{{/if}}">
                                        <i class="bi bi-camera-video"></i> {{this.videos.length}} bài
                                    </small>
                                </div>
                                <div class="lecture-status">
                                    {{#if (eq this.id ../lecture.id)}}
                                        <i class="bi bi-check-circle-fill text-white"></i>
                                    {{else}}
                                        <i class="bi bi-circle text-muted"></i>
                                    {{/if}}
                                </div>
                            </a>
                        </div>
                        {{/each}}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content với video player -->
        <div class="col-lg-9 col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div class="mb-2 mb-md-0">
                            <h5 class="mb-1 fw-bold">{{lecture.lecture_title}}</h5>
                            <small class="text-muted">
                                <i class="bi bi-tag me-1"></i>{{course.category_name}}
                            </small>
                        </div>
                        <div class="lecture-navigation d-flex gap-2">
                            {{#if previousLecture}}
                            <a href="/courses/{{course.course_id}}/lecture/{{previousLecture.id}}" 
                               class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-chevron-left"></i> Trước
                            </a>
                            {{/if}}
                            {{#if nextLecture}}
                            <a href="/courses/{{course.course_id}}/lecture/{{nextLecture.id}}" 
                               class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
                                Tiếp <i class="bi bi-chevron-right"></i>
                            </a>
                            {{/if}}
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Video Player -->
                    <div class="video-container mb-4">
                        {{#if currentVideo}}
                        <video id="player" 
                               class="plyr-video w-100" 
                               controls 
                               crossorigin 
                               playsinline 
                               poster="{{currentVideo.thumbnail_url}}">
                            <source src="{{currentVideo.video_url}}" type="video/mp4">
                            <p>Trình duyệt của bạn không hỗ trợ video HTML5.</p>
                        </video>
                        <div class="mt-2">
                            <small class="text-muted">
                                <strong>Debug:</strong> Video URL: {{currentVideo.video_url}}
                            </small>
                        </div>
                        {{else if lecture.videos.length}}
                        <!-- Fallback: Sử dụng video đầu tiên trong chương -->
                        <video id="player" 
                               class="plyr-video w-100" 
                               controls 
                               crossorigin 
                               playsinline>
                            <source src="{{lecture.videos.0.video_url}}" type="video/mp4">
                            <p>Trình duyệt của bạn không hỗ trợ video HTML5.</p>
                        </video>
                        <div class="mt-2">
                            <small class="text-muted">
                                <strong>Debug:</strong> Video URL: {{lecture.videos.0.video_url}}
                            </small>
                        </div>
                        {{else}}
                        <div class="video-placeholder bg-light d-flex align-items-center justify-content-center" style="height: 400px;">
                            <div class="text-center">
                                <i class="bi bi-play-circle text-muted" style="font-size: 4rem;"></i>
                                <h5 class="mt-3 text-muted">Video đang được cập nhật</h5>
                                <p class="text-muted">Nội dung video cho chương này sẽ sớm được cập nhật.</p>
                                {{#if lecture.videos.length}}
                                <div class="mt-3">
                                    <small class="badge bg-info me-2">Video ID: {{lecture.videos.0.id}}</small>
                                    <small class="badge bg-info">Thời lượng: {{lecture.videos.0.duration}} giây</small>
                                </div>
                                {{/if}}
                            </div>
                        </div>
                        {{/if}}
                    </div>

                    <!-- Video List trong chương -->
                    {{#if lecture.videos}}
                    <div class="video-list">
                        <h6 class="mb-3">
                            <i class="fas fa-video"></i> Danh sách video trong chương
                        </h6>
                        <div class="list-group">
                            {{#each lecture.videos}}
                            <div class="list-group-item video-item {{#if @first}}active{{/if}}" 
                                 data-video-id="{{this.id}}" 
                                 data-video-url="{{this.video_url}}"
                                 data-video-title="{{this.video_title}}">
                                <div class="d-flex align-items-center">
                                    <div class="video-thumbnail me-3">
                                        {{#if this.thumbnail_url}}
                                        <img src="{{this.thumbnail_url}}" 
                                             alt="{{this.video_title}}" 
                                             class="rounded video-thumb" 
                                             style="width: 60px; height: 40px; object-fit: cover;">
                                        {{else}}
                                        <div class="video-thumb-placeholder rounded d-flex align-items-center justify-content-center bg-light" 
                                             style="width: 60px; height: 40px;">
                                            <i class="fas fa-play text-muted"></i>
                                        </div>
                                        {{/if}}
                                    </div>
                                    <div class="video-info flex-grow-1">
                                        <h6 class="mb-1">{{this.video_title}}</h6>
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> {{format_time this.duration}}
                                        </small>
                                    </div>
                                    <div class="video-status">
                                        <i class="fas fa-play-circle text-primary"></i>
                                    </div>
                                </div>
                            </div>
                            {{/each}}
                        </div>
                    </div>
                    {{else}}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Chương này chưa có video nào.
                    </div>
                    {{/if}}

                    <!-- Mô tả chương -->
                    {{#if lecture.description}}
                    <div class="lecture-description mt-4">
                        <h6><i class="fas fa-info-circle"></i> Mô tả chương</h6>
                        <p class="text-muted">{{lecture.description}}</p>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plyr.io CSS -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<link rel="stylesheet" href="/css/lecture-learning.css" />

<!-- Plyr.io JavaScript -->
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script src="/js/lecture-learning.js"></script>

<style>
/* Lecture Learning Styles */
.lecture-header {
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.lecture-sidebar {
    border-radius: 12px;
    overflow: hidden;
}

.lecture-sidebar .card-header {
    border: none;
}

/* Lecture Item Hover Effect */
.hover-lecture:hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    transform: translateX(5px);
}

.hover-lecture:hover .bi-play-circle {
    color: #667eea !important;
}

/* Progress Bar Gradient */
.progress-bar {
    border-radius: 10px;
}

/* Active Lecture Item */
.lecture-item.active a {
    border-radius: 8px;
}

.lecture-item a {
    border-radius: 8px;
    margin: 2px;
}

/* Video Container */
.video-container {
    background: #000;
    border-radius: 12px;
    overflow: hidden;
}

/* Video List */
.video-item {
    border: none;
    border-radius: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.video-item:hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transform: translateX(5px);
}

.video-item.active {
    background: linear-gradient(135deg, #e7f3ff 0%, #cfe7ff 100%);
    border-left: 4px solid #667eea;
}
</style>
